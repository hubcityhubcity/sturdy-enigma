<template>
  <TmPage data-title="Proposal" hide-header class="small">
    <TmDataLoading v-if="$apollo.loading && !loaded" />
    <TmDataNotFound v-else-if="!found" />
    <TmDataError v-else-if="error" />
    <template v-else>
      <div class="proposal">
        <div class="page-profile__header__info">
          <span :class="proposal.status | lowerCase" class="proposal-status">
            {{ status.badge }}
          </span>
          <div class="proposal-title__row">
            <router-link
              :to="`/proposals/` + getPrevProposalId"
              :style="{ visibility: getPrevProposalId ? 'visible' : 'hidden' }"
              class="read-more-link"
            >
              <i class="material-icons">chevron_left</i>
            </router-link>
            <h2 class="proposal-title">{{ proposal.title }}</h2>
            <router-link
              :to="`/proposals/` + getNextProposalId"
              :style="{ visibility: getNextProposalId ? 'visible' : 'hidden' }"
              class="read-more-link"
            >
              <i class="material-icons">chevron_right</i>
            </router-link>
          </div>
          <p class="proposer">
            <template v-if="proposal.validator">
              Proposed by {{ proposal.validator.name }}:
              <Bech32 :address="proposal.proposer" />
            </template>
            <template v-else-if="proposal.proposer !== `unknown`">
              Proposed by
              <Bech32 :address="proposal.proposer" />
            </template>
            <template v-else>
              Unknown proposer
            </template>
          </p>
        </div>
        <div class="button-container">
          <TmBtn
            v-if="proposal.status !== 'Passed'"
            id="deposit-btn"
            :value="connected ? 'Deposit' : 'Connecting...'"
            :disabled="proposal.status !== 'DepositPeriod'"
            color="primary"
            @click.native="onDeposit"
          />
          <TmBtn
            id="vote-btn"
            :value="connected ? 'Vote' : 'Connecting...'"
            :disabled="proposal.status !== 'VotingPeriod'"
            color="primary"
            @click.native="() => onVote()"
          />
        </div>
      </div>

      <TextBlock :content="proposal.description" />

      <ul v-if="proposal.status === 'DepositPeriod'" class="row">
        <li>
          <h4>Deposit Count</h4>
          <span>
            {{ proposal.deposit }}
            /
            {{ parameters.depositThreshold }}
            {{ parameters.depositDenom }}
          </span>
        </li>
      </ul>

      <ul v-if="proposal.status !== `DepositPeriod`" class="row">
        <li v-if="proposal.status === `VotingPeriod`">
          <h4>Total Vote Count</h4>
          <span>
            {{ proposal.tally.totalVotedPercentage | percent }} /
            {{ proposal.tally.total | prettyInt }}
          </span>
        </li>
        <li>
          <h4>Yes</h4>
          <span>
            {{
              noVotes
                ? 0
                : (proposal.tally.yes / proposal.tally.total) | percent
            }}
            /
            {{ proposal.tally.yes | prettyInt }}
          </span>
        </li>
        <li>
          <h4>No</h4>
          <span>
            {{
              noVotes ? 0 : (proposal.tally.no / proposal.tally.total) | percent
            }}
            /
            {{ proposal.tally.no | prettyInt }}
          </span>
        </li>
        <li>
          <h4>Veto</h4>
          <span>
            {{
              noVotes
                ? 0
                : (proposal.tally.veto / proposal.tally.total) | percent
            }}
            /
            {{ proposal.tally.veto | prettyInt }}
          </span>
        </li>
        <li>
          <h4>Abstain</h4>
          <span>
            {{
              noVotes
                ? 0
                : (proposal.tally.abstain / proposal.tally.total) | percent
            }}
            /
            {{ proposal.tally.abstain | prettyInt }}
          </span>
        </li>
      </ul>

      <ul class="row">
        <li>
          <h4>Proposal ID</h4>
          <span>{{ proposal.id }}</span>
        </li>
        <li>
          <h4>Submitted</h4>
          <span>{{ proposal.creationTime | date }}</span>
        </li>
        <template
          v-if="['DepositPeriod', 'VotingPeriod'].includes(proposal.status)"
        >
          <li>
            <h4>{{ status.badge }} Start Date</h4>
            <span>{{ proposal.statusBeginTime | date }}</span>
          </li>
          <li>
            <h4>{{ status.badge }} End Date</h4>
            <span>
              {{ proposal.statusEndTime | date }} /
              {{ proposal.statusEndTime | fromNow }}
            </span>
          </li>
        </template>
        <template v-else>
          <li>
            <h4>Proposal Finalized ({{ status.badge }})</h4>
            <span>{{ proposal.statusEndTime | date }}</span>
          </li>
        </template>
      </ul>

      <ModalDeposit
        ref="modalDeposit"
        :proposal-id="proposalId"
        :proposal-title="proposal.title || ''"
        :denom="parameters.depositDenom"
        @success="() => afterDeposit()"
      />
      <ModalVote
        ref="modalVote"
        :proposal-id="proposalId"
        :proposal-title="proposal.title || ''"
        :last-vote-option="vote"
        @success="() => afterVote()"
      />
    </template>
  </TmPage>
</template>

<script>
import { mapGetters } from "vuex"
import { atoms, percent, prettyInt } from "scripts/num"
import { date, fromNow } from "src/filters"
import TmBtn from "common/TmBtn"
import TmDataError from "common/TmDataError"
import TmDataNotFound from "common/TmDataNotFound"
import TmDataLoading from "common/TmDataLoading"
import TextBlock from "common/TextBlock"
import ModalDeposit from "src/ActionModal/components/ModalDeposit"
import ModalVote from "src/ActionModal/components/ModalVote"
import TmPage from "common/TmPage"
import { getProposalStatus } from "scripts/proposal-status"
import { ProposalItem, GovernanceParameters, Vote } from "src/gql"
import BigNumber from "bignumber.js"
import Bech32 from "common/Bech32"
import gql from "graphql-tag"
import refetchNetworkOnly from "scripts/refetch-network-only"

export default {
  name: `page-proposal`,
  components: {
    TmBtn,
    ModalDeposit,
    ModalVote,
    TmDataError,
    TmDataNotFound,
    TmDataLoading,
    TmPage,
    TextBlock,
    Bech32
  },
  filters: {
    prettyInt,
    atoms,
    percent,
    date,
    fromNow,
    lowerCase: text => text.toLowerCase()
  },
  props: {
    proposalId: {
      type: String,
      required: true
    }
  },
  data: () => ({
    proposals: [],
    vote: undefined,
    proposal: {
      status: "",
      proposer: "",
      tally: {},
      validator: {}
    },
    parameters: {
      depositDenom: "TESTCOIN"
    },
    error: undefined,
    found: false,
    loaded: false
  }),
  computed: {
    ...mapGetters([`address`, `network`]),
    ...mapGetters([`connected`]),
    status() {
      return getProposalStatus(this.proposal)
    },
    noVotes() {
      return BigNumber(this.proposal.tally.total).eq(0)
    },
    getNextProposalId() {
      let id = this.getProposalIndex(-1)
      return id
    },
    getPrevProposalId() {
      let id = this.getProposalIndex(1)
      return id
    }
  },
  watch: {
    // Needed to show data loading component when you are browsing from one proposal to another
    $route: function() {
      this.loaded = false
    }
  },
  methods: {
    onVote() {
      this.$refs.modalVote.open()
    },
    afterVote() {
      this.$apollo.queries.vote.refetch({
        proposalId: this.proposal.id,
        address: this.address
      })
      this.$store.commit("invalidateCache", [`overview`, `transactions`])
    },
    onDeposit() {
      this.$refs.modalDeposit.open()
    },
    afterDeposit() {
      this.$apollo.queries.proposal.refetch({
        id: this.proposal.id
      })
      this.$store.commit("invalidateCache", [`overview`, `transactions`])
    },
    getProposalIndex(num) {
      let proposalsObj = this.proposals
      let proposalsIdArr = Object.values(proposalsObj).map(
        proposal => proposal.id
      )
      return proposalsIdArr[proposalsIdArr.indexOf(this.proposal.id) + num]
    }
  },
  apollo: {
    proposals: {
      query() {
        /* istanbul ignore next */
        return gql`
          query proposals($networkId: String!) {
            proposals(networkId: $networkId) {
              id
              status
            }
          }
        `
      },
      variables() {
        /* istanbul ignore next */
        return {
          networkId: this.network
        }
      },
      update(data) {
        /* istanbul ignore next */
        if (
          data.proposals.find(
            proposal => proposal.id === parseInt(this.proposalId, 10)
          )
        ) {
          this.found = true
        }
        /* istanbul ignore next */
        return data.proposals
      }
    },
    proposal: {
      query() {
        /* istanbul ignore next */
        return ProposalItem(this.network)
      },
      update(data) {
        /* istanbul ignore next */
        this.loaded = true
        /* istanbul ignore next */
        return data.proposal
      },
      variables() {
        /* istanbul ignore next */
        return {
          id: +this.proposalId
        }
      },
      skip() {
        /* istanbul ignore next */
        return !this.found
      },
      result(data) {
        /* istanbul ignore next */
        this.error = data.error
      }
    },
    parameters: {
      query() {
        /* istanbul ignore next */
        return GovernanceParameters(this.network)
      },
      update(data) {
        /* istanbul ignore next */
        return data.governanceParameters
      },
      skip() {
        /* istanbul ignore next */
        return !this.found
      },
      result(data) {
        /* istanbul ignore next */
        this.error = data.error
      }
    },
    vote: {
      query() {
        /* istanbul ignore next */
        return Vote(this.network)
      },
      variables() {
        /* istanbul ignore next */
        return {
          proposalId: +this.proposalId,
          address: this.address
        }
      },
      skip() {
        /* istanbul ignore next */
        return !this.address || !this.found
      },
      update(data) {
        /* istanbul ignore next */
        return data.vote.option
      },
      result(data) {
        /* istanbul ignore next */
        this.error = data.error
      }
    },
    $subscribe: {
      blockAdded: {
        variables() {
          /* istanbul ignore next */
          return {
            networkId: this.network
          }
        },
        query() {
          /* istanbul ignore next */
          return gql`
            subscription($networkId: String!) {
              blockAdded(networkId: $networkId) {
                height
              }
            }
          `
        },
        skip() {
          /* istanbul ignore next */
          return !this.found
        },
        result() {
          /* istanbul ignore next */
          if (
            // Don't update passed or rejected proposals
            this.proposal.status !== "Passed" &&
            this.proposal.status !== "Rejected" &&
            this.loaded
          ) {
            refetchNetworkOnly(this.$apollo.queries.proposal)
            refetchNetworkOnly(this.$apollo.queries.parameters)
            refetchNetworkOnly(this.$apollo.queries.vote)
          }
        }
      }
    }
  }
}
</script>

<style scoped>
@import "../../styles/proposal-status.css";

.proposal-title__row {
  color: var(--bright);
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.proposal-title__row a {
  color: var(--bright);
  padding-top: 1rem;
}

.proposal-title__row a:hover {
  color: var(--link-hover);
  padding-top: 1rem;
}

.proposal-title {
  text-align: center;
  color: var(--bright);
  font-size: var(--h1);
  line-height: 2.25rem;
  font-weight: 500;
  padding-top: 1rem;
}

.proposer {
  font-size: 14px;
  padding-top: 1rem;
}

.text-block {
  padding: 0 1rem 3rem;
}

.button-container {
  display: flex;
  align-items: flex-end;
  padding: 0.5rem 1rem;
  border-top: 1px solid var(--bc-dim);
  border-bottom: 1px solid var(--bc-dim);
}

.page-profile__header__info {
  padding: 1rem;
}

.button-container button:first-child {
  margin-right: 0.5rem;
}

@media screen and (max-width: 667px) {
  .button-container {
    width: 100%;
    padding: 1rem;
  }

  .button-container button {
    width: 50%;
  }
}
</style>
